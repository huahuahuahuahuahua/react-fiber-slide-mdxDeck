<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.15.29"/><title data-react-helmet="true">React 16 Fiber 的简单了解</title><link as="script" rel="preload" href="/webpack-runtime-6325f01cfc8204c7dff0.js"/><link as="script" rel="preload" href="/commons-15505dbdcd717bdf87dd.js"/><link as="script" rel="preload" href="/app-901f5929c480a9ffd786.js"/><link as="script" rel="preload" href="/component---gatsby-theme-mdx-deck-src-templates-deck-js-862c04b17d6a8697b9b0.js"/><link as="fetch" rel="preload" href="/page-data\print\page-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
        var mode = localStorage.getItem('theme-ui-color-mode');
        if (!mode) return
        document.body.classList.add('theme-ui-' + mode);
      } catch (e) {} })();</script><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><style data-emotion-css="13j5fvw">body{margin:0;}</style><style data-emotion-css="bdfrlc">.css-bdfrlc{width:100vw;height:100vh;}.css-bdfrlc *{box-sizing:border-box;}</style><div class="css-bdfrlc"><div style="outline:none;height:100%" tabindex="-1" role="group"><style data-emotion-css="gxvojt">.css-gxvojt{box-sizing:border-box;width:100%;height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;overflow:hidden;position:relative;color:var(--theme-ui-colors-text,#9CDCFE);background-color:var(--theme-ui-colors-background,#1E1E1E);font-family:system-ui,sans-serif;font-size:20px;}@media screen and (min-width:40em){.css-gxvojt{font-size:24px;}}@media screen and (min-width:52em){.css-gxvojt{font-size:32px;}}@media screen and (min-width:64em){.css-gxvojt{font-size:48px;}}</style><div class="css-gxvojt"><style data-emotion-css="1djqpdg">.css-1djqpdg{font-family:inherit;line-height:1.125;font-weight:700;}</style><h2 class="css-1djqpdg">React 16 Fiber 的简单了解</h2><h6 class="css-1djqpdg">(内容涉及了 Stack reconciler，Fiber reconciler，以及它们之间的区别。)</h6></div><div class="css-gxvojt"><h3 class="css-1djqpdg">Animation Effect</h3><style data-emotion-css="5r4te6">.css-5r4te6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:100%;text-align:center;}</style><div class="css-5r4te6"><style data-emotion-css="11ze7cv">.css-11ze7cv{width:50%;}</style><div class="css-11ze7cv">15 Stack reconciler<style data-emotion-css="wnzno2">.css-wnzno2{max-width:100%;height:auto;object-fit:cover;}</style><img style="width:500px" src="/static/smothReconciler-36ba1519499985f3e425aead4b96bf83.gif" class="css-wnzno2"/></div><div class="css-11ze7cv">16 Fiber reconciler<img style="width:500px" src="/static/smothReconciler-36ba1519499985f3e425aead4b96bf83.gif" class="css-wnzno2"/></div></div><h6 class="css-1djqpdg">两边都很流畅</h6></div><div class="css-gxvojt"><h3 class="css-1djqpdg">Animation Effect</h3><div class="css-5r4te6"><div class="css-11ze7cv">15 Stack reconciler<img style="width:600px" src="/static/stackReconciler-8312f74c6c0011dd5e033481572db4fd.gif" class="css-wnzno2"/></div><div class="css-11ze7cv">16 Fiber reconciler<img style="width:600px" src="/static/fiberReconciler-1e413d5a6db266ef5c17b1df99d24aec.gif" class="css-wnzno2"/></div></div><h6 class="css-1djqpdg"><span style="color:yellow">左边明显卡顿</span>，这是由于<span style="color:yellow">缺乏优先级</span>，table 变化一直占用主线程，<span style="color:yellow">动画无法正常渲染</span></h6></div><div class="css-gxvojt"><h3 class="css-1djqpdg">virtual dom</h3><div class="css-5r4te6"><div class="css-11ze7cv"><h5 class="css-1djqpdg">react 中，一个 <span style="color:yellow">virtual dom </span> 是使用 element 来表示的。</h5><h6 class="css-1djqpdg"> </h6><h5 class="css-1djqpdg">在 React15 Stack Reconciler 策略中，React 采用<span style="color:yellow">递归</span>的方式来生成或者更新内部树。</h5></div><div class="css-11ze7cv"><img style="width:600px;height:550px" src="data:image/png;base64,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1z17MwEdAeo8+7F537Z/3bbx/SZPxbMXsCIiT8mzNUUgIvIUKWBFRAw58LsIvOfM3Ez/XrqIiJPmYEVEDNEUgYiIIQpYERFDFLAiIoYoYEVEDFHAiogYooAVETFEASsiYogCVkTEEAWsiIghClgREUMUsCIihihgRUQMUcCKiBiigBURMYX8QoIAAAFLSURBVGSPA7aHi0YK94mI7L09DthrDL/9Fn/8f/+D//nLve2JiEipaYpARMQQBayIiCH7JGAPU1m/130QESmtfRGw/xL9V/jNJ0y++6u97oqISMnsi6qy/3vkn+GPbxG+vtc9EREpnX0xgoUfWH2w130QESmtfRKwIiLlRwErImLIvvhNrt/8t//Df/xpb3siIlJqPzl16tQ/9roTIiLlSFMEIiKGKGBFRAxRwIqIGKKAFRExRAErImKIAlZExBAFrIiIIQpYERFDFLAiIoYoYEVEDFHAiogYooAVETFEASsiYogCVkTEEAWsiIghClgREUMUsCIihihgRUQMUcCKiBiigBURMUQBKyJiiAJWRMQQBayIiCEKWBERQxSwIiKGKGBFRAxRwIqIGKKAFRExRAErImKIAlZExBAFrIiIIQpYERFDFLAiIob8f7kAtdh+Ivn0AAAAAElFTkSuQmCC" class="css-wnzno2"/></div></div></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:row;justify-content:center;align-items:center;font-size:0.8em;position:relative" class="cs-col-layout"><div style="flex:1;overflow:hidden;height:100%"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><style data-emotion-css="oedec6">.css-oedec6{color:#9CDCFE;background-color:#1E1E1E;}.css-oedec6 .token-prolog{color:rgb(0,0,128);}.css-oedec6 .token-comment{color:rgb(106,153,85);}.css-oedec6 .token-builtin,.css-oedec6 .token-changed,.css-oedec6 .token-keyword{color:rgb(86,156,214);}.css-oedec6 .token-number,.css-oedec6 .token-inserted{color:rgb(181,206,168);}.css-oedec6 .token-constant{color:rgb(100,102,149);}.css-oedec6 .token-attr-name,.css-oedec6 .token-variable{color:rgb(156,220,254);}.css-oedec6 .token-deleted,.css-oedec6 .token-string,.css-oedec6 .token-attr-value{color:rgb(206,145,120);}.css-oedec6 .token-selector{color:rgb(215,186,125);}.css-oedec6 .token-tag{color:rgb(86,156,214);}.css-oedec6 .token-punctuation,.css-oedec6 .token-operator{color:rgb(212,212,212);}.css-oedec6 .token-punctuation{color:#808080;}.css-oedec6 .token-function{color:rgb(220,220,170);}.css-oedec6 .token-class-name{color:rgb(78,201,176);}.css-oedec6 .token-char{color:rgb(209,105,105);}</style><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><style data-emotion-css="xbe36b">.css-xbe36b{color:#9CDCFE;background-color:#1E1E1E;}</style><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-comment">//Jsx &amp;&amp; element节点</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-keyword">export</span><span class="token-plain"> </span><span class="token-keyword">const</span><span class="token-plain"> element </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain">  type</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-string">&quot;button&quot;</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">  props</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">    className</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-string">&quot;button button-blue&quot;</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain">    children</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">      type</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-string">&quot;b&quot;</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">      props</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">        children</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-string">&quot;OK!&quot;</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">      </span><span class="token-punctuation">}</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-plain">    </span><span class="token-punctuation">}</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">  </span><span class="token-punctuation">}</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-punctuation">}</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><style data-emotion-css="1q54swq">.css-1q54swq{position:absolute;top:0;width:100%;margin:0;padding:1em 0;text-align:center;background-color:#1E1E1E;color:#9CDCFE;}</style><h4 class="cs-title css-1q54swq"><span>DOM Elements</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">    className</span><span class="token-punctuation">:</span><span class="token-plain"> </span><span class="token-string">&quot;button button-blue&quot;</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-punctuation">}</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">DOM Elements</span></h4></div></div></div></div><div style="flex:1;overflow:hidden;height:100%"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><style data-emotion-css="n2kuek">.css-n2kuek{color:#393A34;background-color:#f6f8fa;}.css-n2kuek .token-prolog{color:rgb(0,0,128);}.css-n2kuek .token-comment{color:rgb(106,153,85);}.css-n2kuek .token-builtin,.css-n2kuek .token-changed,.css-n2kuek .token-keyword{color:rgb(86,156,214);}.css-n2kuek .token-number,.css-n2kuek .token-inserted{color:rgb(181,206,168);}.css-n2kuek .token-constant{color:rgb(100,102,149);}.css-n2kuek .token-attr-name,.css-n2kuek .token-variable{color:rgb(156,220,254);}.css-n2kuek .token-deleted,.css-n2kuek .token-string,.css-n2kuek .token-attr-value{color:rgb(206,145,120);}.css-n2kuek .token-selector{color:rgb(215,186,125);}.css-n2kuek .token-tag{color:rgb(86,156,214);}.css-n2kuek .token-punctuation,.css-n2kuek .token-operator{color:#393A34;}.css-n2kuek .token-punctuation{color:#808080;}.css-n2kuek .token-function{color:rgb(220,220,170);}.css-n2kuek .token-class-name{color:rgb(78,201,176);}.css-n2kuek .token-char{color:rgb(209,105,105);}.css-n2kuek .token-comment,.css-n2kuek .token-prolog,.css-n2kuek .token-doctype,.css-n2kuek .token-cdata{color:#999988;font-style:italic;}.css-n2kuek .token-namespace{opacity:0.7;}.css-n2kuek .token-string,.css-n2kuek .token-attr-value{color:#e3116c;}.css-n2kuek .token-entity,.css-n2kuek .token-url,.css-n2kuek .token-symbol,.css-n2kuek .token-number,.css-n2kuek .token-boolean,.css-n2kuek .token-variable,.css-n2kuek .token-constant,.css-n2kuek .token-property,.css-n2kuek .token-regex,.css-n2kuek .token-inserted{color:#36acaa;}.css-n2kuek .token-atrule,.css-n2kuek .token-keyword,.css-n2kuek .token-attr-name,.css-n2kuek .token-selector{color:#00a4db;}.css-n2kuek .token-function,.css-n2kuek .token-deleted,.css-n2kuek .token-tag{color:#d73a49;}.css-n2kuek .token-function-variable{color:#6f42c1;}.css-n2kuek .token-tag,.css-n2kuek .token-selector{color:#00009f;}</style><pre class="cs-content css-n2kuek" style="margin:0;height:100%;overflow:hidden"><style data-emotion-css="xdak34">.css-xdak34{color:#393A34;background-color:#f6f8fa;}</style><code class="cs-scaled-content css-xdak34" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-operator">&lt;</span><span class="token-plain">button </span><span class="token-keyword">class</span><span class="token-operator">=</span><span class="token-string">&quot;button button-blue&quot;</span><span class="token-operator">&gt;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-operator">&lt;</span><span class="token-plain">b</span><span class="token-operator">&gt;</span><span class="token-constant">OK</span><span class="token-operator">!</span><span class="token-operator">&lt;</span><span class="token-operator">/</span><span class="token-plain">b</span><span class="token-operator">&gt;</span></div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-operator">&lt;</span><span class="token-operator">/</span><span class="token-plain">button</span><span class="token-operator">&gt;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><style data-emotion-css="1xose5o">.css-1xose5o{position:absolute;top:0;width:100%;margin:0;padding:1em 0;text-align:center;background-color:#f6f8fa;color:#393A34;}</style><h4 class="cs-title css-1xose5o"><span>HTML片段</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-n2kuek" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xdak34" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-operator">&lt;</span><span class="token-plain">button </span><span class="token-keyword">class</span><span class="token-operator">=</span><span class="token-string">&quot;button button-blue&quot;</span><span class="token-operator">&gt;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-operator">&lt;</span><span class="token-operator">/</span><span class="token-plain">button</span><span class="token-operator">&gt;</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1xose5o" style="opacity:1"><span style="opacity:1">HTML片段</span></h4></div></div></div></div></div></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:row;justify-content:center;align-items:center;font-size:0.8em;position:relative" class="cs-col-layout"><div style="flex:1;overflow:hidden;height:100%"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">class</span><span class="token-plain"> </span><span class="token-class-name">InternalComponent</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-plain">  </span><span class="token-comment">// 接受一个组件</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-function">r</span><span class="token-function">e</span><span class="token-function">c</span><span class="token-function">e</span><span class="token-function">i</span><span class="token-function">v</span><span class="token-function">e</span><span class="token-function">C</span><span class="token-function">o</span><span class="token-function">m</span><span class="token-function">p</span><span class="token-function">o</span><span class="token-function">n</span><span class="token-function">e</span><span class="token-function">n</span><span class="token-function">t</span><span class="token-punctuation">(</span><span class="token-parameter">n</span><span class="token-parameter">e</span><span class="token-parameter">x</span><span class="token-parameter">t</span><span class="token-parameter">E</span><span class="token-parameter">l</span><span class="token-parameter">e</span><span class="token-parameter">m</span><span class="token-parameter">e</span><span class="token-parameter">n</span><span class="token-parameter">t</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> prevElement </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_currentElement</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-plain">    </span><span class="token-comment">// 调用函数更新组件</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-keyword">t</span><span class="token-keyword">h</span><span class="token-keyword">i</span><span class="token-keyword">s</span><span class="token-punctuation">.</span><span class="token-method">u</span><span class="token-method">p</span><span class="token-method">d</span><span class="token-method">a</span><span class="token-method">t</span><span class="token-method">e</span><span class="token-method">C</span><span class="token-method">o</span><span class="token-method">m</span><span class="token-method">p</span><span class="token-method">o</span><span class="token-method">n</span><span class="token-method">e</span><span class="token-method">n</span><span class="token-method">t</span><span class="token-punctuation">(</span><span class="token-plain">p</span><span class="token-plain">r</span><span class="token-plain">e</span><span class="token-plain">v</span><span class="token-plain">E</span><span class="token-plain">l</span><span class="token-plain">e</span><span class="token-plain">m</span><span class="token-plain">e</span><span class="token-plain">n</span><span class="token-plain">t</span><span class="token-punctuation">,</span><span class="token-plain"> </span><span class="token-plain">n</span><span class="token-plain">e</span><span class="token-plain">x</span><span class="token-plain">t</span><span class="token-plain">E</span><span class="token-plain">l</span><span class="token-plain">e</span><span class="token-plain">m</span><span class="token-plain">e</span><span class="token-plain">n</span><span class="token-plain">t</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-function">u</span><span class="token-function">p</span><span class="token-function">d</span><span class="token-function">a</span><span class="token-function">t</span><span class="token-function">e</span><span class="token-function">C</span><span class="token-function">o</span><span class="token-function">m</span><span class="token-function">p</span><span class="token-function">o</span><span class="token-function">n</span><span class="token-function">e</span><span class="token-function">n</span><span class="token-function">t</span><span class="token-punctuation">(</span><span class="token-parameter">p</span><span class="token-parameter">r</span><span class="token-parameter">e</span><span class="token-parameter">v</span><span class="token-parameter">P</span><span class="token-parameter">a</span><span class="token-parameter">r</span><span class="token-parameter">e</span><span class="token-parameter">n</span><span class="token-parameter">t</span><span class="token-parameter">E</span><span class="token-parameter">l</span><span class="token-parameter">e</span><span class="token-parameter">m</span><span class="token-parameter">e</span><span class="token-parameter">n</span><span class="token-parameter">t</span><span class="token-punctuation">,</span><span class="token-parameter"> </span><span class="token-parameter">n</span><span class="token-parameter">e</span><span class="token-parameter">x</span><span class="token-parameter">t</span><span class="token-parameter">P</span><span class="token-parameter">a</span><span class="token-parameter">r</span><span class="token-parameter">e</span><span class="token-parameter">n</span><span class="token-parameter">t</span><span class="token-parameter">E</span><span class="token-parameter">l</span><span class="token-parameter">e</span><span class="token-parameter">m</span><span class="token-parameter">e</span><span class="token-parameter">n</span><span class="token-parameter">t</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">    </span><span class="token-comment">// 更新当前节点的props和state</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> prevProps </span><span class="token-operator">=</span><span class="token-plain"> prevParentElement</span><span class="token-punctuation">.</span><span class="token-property-access">props</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextProps </span><span class="token-operator">=</span><span class="token-plain"> nextParentElement</span><span class="token-punctuation">.</span><span class="token-property-access">props</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">    </span><span class="token-comment">//将setState的partialState与原state合并</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextState </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-method">_processPendingState</span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">      nextProps</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">      nextContext</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-15"><span class="token-plain">    </span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-plain">    </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-property-access">props</span><span class="token-plain"> </span><span class="token-operator">=</span><span class="token-plain"> nextProps</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-17"><span class="token-plain">    </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-property-access">state</span><span class="token-plain"> </span><span class="token-operator">=</span><span class="token-plain"> nextState</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-18"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-19"><span class="token-plain">    </span><span class="token-comment">// 更新子节点</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-20"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> prevComponentInstance </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_renderedComponent</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-21"><span class="token-plain">    </span><span class="token-comment">// 上次render出来的element</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-22"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> prevRenderedElement </span><span class="token-operator">=</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-23"><span class="token-plain">      prevComponentInstance</span><span class="token-punctuation">.</span><span class="token-property-access">_currentElement</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-24"><span class="token-plain">    </span><span class="token-comment">// 调用component 的 render，获取新的element</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextRenderedElement </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-method">render</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-26"><span class="token-plain">    </span><span class="token-comment">// 判断是否是仅仅需要更新子节点</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-27"><span class="token-plain">    </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-28"><span class="token-plain">      </span><span class="token-function">shouldUpdateReactComponent</span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-29"><span class="token-plain">        prevRenderedElement</span><span class="token-punctuation">,</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-30"><span class="token-plain">        nextRenderedElement</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-31"><span class="token-plain">      </span><span class="token-punctuation">)</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-32"><span class="token-plain">    </span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-33"><span class="token-plain">      </span><span class="token-comment">// 子节点，递归调用receiveComponent</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-34"><span class="token-plain">      prevComponentInstance</span><span class="token-punctuation">.</span><span class="token-method">receiveComponent</span><span class="token-punctuation">(</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-35"><span class="token-plain">        nextRenderedElement</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-36"><span class="token-plain">      </span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-37"><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-plain"> </span><span class="token-punctuation">}</span><span class="token-plain"> </span><span class="token-keyword">e</span><span class="token-keyword">l</span><span class="token-keyword">s</span><span class="token-keyword">e</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-38"><span class="token-plain">      </span><span class="token-comment">// 否则，卸载旧的子节点，然后走新建子节点流程</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-39"><span class="token-plain">    </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-40"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-41"><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">React 15 栈协调更新机制（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">      nextContext</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextRenderedElement </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-method">render</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">      nextContext</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextRenderedElement </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-method">render</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:0"><span style="opacity:1"></span></h4><style data-emotion-css="fs2d1k">.css-fs2d1k{position:absolute;bottom:0;width:calc(100% - 2em);box-sizing:border-box;margin:0.3em 1em;padding:0.5em;background:rgba(2,2,2,0.9);text-align:center;color:#d6deeb;background-color:rgba(10,10,10,0.9);}</style><p class="cs-subtitle css-fs2d1k" style="opacity:0"><span style="opacity:1"></span></p></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">      nextContext</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    </span><span class="token-keyword">var</span><span class="token-plain"> nextRenderedElement </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">this</span><span class="token-punctuation">.</span><span class="token-property-access">_publicInstance</span><span class="token-punctuation">.</span><span class="token-method">render</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">React 15 栈协调更新机制（伪代码）</span></h4><p class="cs-subtitle css-fs2d1k" style="opacity:1"><span style="opacity:1">基于递归的深度优先遍历进行更新组件</span></p></div></div></div></div></div></div><div class="css-gxvojt"><h3 class="css-1djqpdg">React 15 stack Reconciler 的缺点</h3><style data-emotion-css="1uk1gs8">.css-1uk1gs8{margin:0;}</style><ul class="css-1uk1gs8"><li class="css-0"><p class="css-0">如果当前<span style="color:yellow">组件层次非常深</span>，那么组件更新<span style="color:yellow">耗时非常长</span></p></li><li class="css-0"><p class="css-0">对于动画场景而言，如果一帧时间超过 16ms，就会出现<span style="color:yellow">掉帧，动画不流畅</span></p></li><li class="css-0"><p class="css-0">低优先级的组件（比如隐藏，屏幕外），也会占用更新资源，<span style="color:yellow">没有优先级之分</span></p></li></ul></div><div class="css-gxvojt"><h2 class="css-1djqpdg">what is Fiber</h2><h5 class="css-1djqpdg">Fiber 的中文翻译叫<span style="color:yellow">纤程，与进程、线程同为程序执行过程</span></h5><h3 class="css-1djqpdg"><span style="color:#b37feb">比线程还要纤细</span>的一个过程。</h3></div><div class="css-gxvojt"><h3 class="css-1djqpdg">Fiber 的结构</h3><div class="css-5r4te6"><div class="css-11ze7cv"><h5 class="css-1djqpdg">相较于原先的 stack node</h5></div><div class="css-11ze7cv"><img style="width:500px;height:500px" src="/static/image-20220514182437794-f4fd14295e0e3dd1a362d5185545e2db.png" class="css-wnzno2"/></div></div></div><div class="css-gxvojt"><h3 class="css-1djqpdg">Fiber 的结构</h3><div class="css-5r4te6"><div class="css-11ze7cv"><h5 class="css-1djqpdg">相较于原先的 stack node</h5><h5 class="css-1djqpdg">增加了</h5><h5 class="css-1djqpdg"><span style="color:yellow">指向父母的箭头</span></h5></div><div class="css-11ze7cv"><img style="width:500px;height:500px" src="/static/image-20220514182508618-0fd4a4d59e929e177c0dbf8e5b7ab8b1.png" class="css-wnzno2"/></div></div></div><div class="css-gxvojt"><h3 class="css-1djqpdg">Fiber 的结构</h3><div class="css-5r4te6"><div class="css-11ze7cv"><h5 class="css-1djqpdg">相较于原先的 stack node</h5><h5 class="css-1djqpdg">增加了</h5><h5 class="css-1djqpdg">指向父母的箭头</h5><h5 class="css-1djqpdg"><span style="color:yellow">指向兄弟姐妹的箭头</span></h5></div><div class="css-11ze7cv"><img style="width:500px;height:500px" src="/static/image-20220514223248106-084c33aa1eeebad82c7781325a9f4f2a.png" class="css-wnzno2"/></div></div></div><div class="css-gxvojt"><h2 class="css-1djqpdg">Fiber 核心架构可以分为三层：</h2><h5 class="css-1djqpdg"><span style="color:yellow">Scheduler 调度器 </span> - 调度任务的优先级</h5><h5 class="css-1djqpdg"><span style="color:yellow">Reconciler 协调器</span> - 负责找出变化的组件</h5><h5 class="css-1djqpdg"><span style="color:yellow"> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- -->Renderer 渲染器 </span> - 负责将变化的组件渲染到页面上</h5></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-comment">// 调度器</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">scheduleCallback</span><span class="token-punctuation">(</span><span class="token-parameter">task</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-comment">//根据优先级处理任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">workLoop</span><span class="token-punctuation">(</span><span class="token-parameter">deadline</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-comment">//构建 Fiber 树中每个 Fiber 的方法</span></div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-comment">//更新视图</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span>Fiber 更新流程（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span>Fiber 更新流程（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span>Fiber 更新流程（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">Fiber 更新流程（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">Fiber 更新流程</span></h4></div></div></div></div></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:row;justify-content:center;align-items:center;font-size:0.8em;position:relative" class="cs-col-layout"><div style="flex:1;overflow:hidden;height:100%"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">let</span><span class="token-plain"> timerQueue </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-punctuation">[</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-keyword">let</span><span class="token-plain"> taskQueue </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-punctuation">[</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-keyword">let</span><span class="token-plain"> shouldYield </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-boolean">false</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-comment">// 调度器</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">scheduleCallback</span><span class="token-punctuation">(</span><span class="token-parameter">task</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">  </span><span class="token-comment">// 向队列中添加任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">  taskQueue</span><span class="token-punctuation">.</span><span class="token-method">push</span><span class="token-punctuation">(</span><span class="token-plain">task</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">  </span><span class="token-comment">// 优先级影响到任务在队列中的排序，将优先级最高的任务排在最前面</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">  taskQueue</span><span class="token-punctuation">.</span><span class="token-method">sort</span><span class="token-punctuation">(</span><span class="token-punctuation">(</span><span class="token-parameter">a</span><span class="token-punctuation">,</span><span class="token-parameter"> b</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-arrow">=&gt;</span><span class="token-plain"> a</span><span class="token-punctuation">.</span><span class="token-property-access">priority</span><span class="token-plain"> </span><span class="token-operator">-</span><span class="token-plain"> b</span><span class="token-punctuation">.</span><span class="token-property-access">priority</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-plain">  </span><span class="token-comment">// 从队列中取出任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> currentTask </span><span class="token-operator">=</span><span class="token-plain"> taskQueue</span><span class="token-punctuation">[</span><span class="token-number">0</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-plain">  nextUnitOfWork </span><span class="token-operator">=</span><span class="token-plain"> currentTask</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">  </span><span class="token-comment">// 请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">  </span><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-15"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-17"><span class="token-comment">//根据优先级处理任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-18"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">workLoop</span><span class="token-punctuation">(</span><span class="token-parameter">deadline</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-19"><span class="token-plain">  </span><span class="token-console">console</span><span class="token-punctuation">.</span><span class="token-method">log</span><span class="token-punctuation">(</span><span class="token-string">&quot;workLoop&quot;</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-20"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> currentWork </span><span class="token-operator">=</span><span class="token-plain"> nextUnitOfWork</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-21"><span class="token-plain">  </span><span class="token-comment">//每次循环都会调用shouldYield判断当前是否有剩余时间。</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-22"><span class="token-plain">  </span><span class="token-keyword">while</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">currentWork </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">shouldYield</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-23"><span class="token-plain">    </span><span class="token-comment">// performUnitOfWork 是DFS（Depth-first search）遍历过程</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-24"><span class="token-plain">    nextUnitOfWork </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-plain">currentWork</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    shouldYield </span><span class="token-operator">=</span><span class="token-plain"> deadline</span><span class="token-punctuation">.</span><span class="token-method">timeRemaining</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-operator">&lt;</span><span class="token-plain"> </span><span class="token-number">1</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-26"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-27"><span class="token-plain">  </span><span class="token-comment">// 如果没有下个单元任务和工作树存在</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-28"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-operator">!</span><span class="token-plain">currentWork </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> wipRoot</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-29"><span class="token-plain">    </span><span class="token-comment">// 提交root任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-30"><span class="token-plain">    </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-31"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-32"><span class="token-plain">  </span><span class="token-comment">//请求主线程空闲时间进行工作循环;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-33"><span class="token-plain">  </span><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-34"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-35"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-36"><span class="token-comment">//构建 Fiber 树中每个 Fiber 的方法</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-37"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-38"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> isFunctionComponent </span><span class="token-operator">=</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-39"><span class="token-plain">    fiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-keyword">instanceof</span><span class="token-plain"> </span><span class="token-class-name">Function</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-40"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">isFunctionComponent</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-41"><span class="token-plain">    </span><span class="token-comment">//函数组件</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-42"><span class="token-plain">    </span><span class="token-function">updateFunctionComponent</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-43"><span class="token-plain">  </span><span class="token-punctuation">}</span><span class="token-plain"> </span><span class="token-keyword">else</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-44"><span class="token-plain">    </span><span class="token-comment">//类组件</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-45"><span class="token-plain">    </span><span class="token-function">updateHostComponent</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-46"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-47"><span class="token-plain">  </span><span class="token-comment">//调和子树</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-48"><span class="token-plain">  </span><span class="token-function">reconcileChildren</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">,</span><span class="token-plain"> children</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-49"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-50"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-51"><span class="token-comment">// 工作树</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-52"><span class="token-keyword">let</span><span class="token-plain"> currentRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-53"><span class="token-comment">// 虚拟树</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-54"><span class="token-keyword">let</span><span class="token-plain"> wipRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-55"><span class="token-comment">// 调和子树</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-56"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">reconcileChildren</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">,</span><span class="token-parameter"> children</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-57"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> sameType </span><span class="token-operator">=</span></div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-59"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-60"><span class="token-plain">    </span><span class="token-comment">// TODO update the node</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-61"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-62"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-63"><span class="token-plain">    </span><span class="token-comment">// TODO add this node</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-64"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-65"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-66"><span class="token-plain">    </span><span class="token-comment">// TODO delete the oldFiber&#x27;s node</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-67"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-68"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-69"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-70"><span class="token-comment">// 更新视图</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-71"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-72"><span class="token-plain">  </span><span class="token-function">commitWork</span><span class="token-punctuation">(</span><span class="token-plain">wipRoot</span><span class="token-punctuation">.</span><span class="token-property-access">child</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-73"><span class="token-plain">  currentRoot </span><span class="token-operator">=</span><span class="token-plain"> wipRoot</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-74"><span class="token-plain">  wipRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-75"><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">Fiber 更新流程（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:1"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">调度器（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">根据优先级处理任务（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">构建 Fiber 树中每个 Fiber 的方法（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">调和子树（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span>更新视图（伪代码）</span></h4></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;opacity:0.3"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq"><span style="opacity:1">更新视图（伪代码）</span></h4><p class="cs-subtitle css-fs2d1k" style="opacity:0"><span style="opacity:1"></span></p></div></div><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">Fiber 更新流程（伪代码）</span></h4><p class="cs-subtitle css-fs2d1k" style="opacity:1"><span style="opacity:1">增加了任务优先级、时间片、任务中断</span></p></div></div></div></div></div></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:row;justify-content:center;align-items:center;font-size:0.8em;position:relative" class="cs-col-layout"><div style="flex:1;overflow:hidden;height:100%"><div style="display:flex;justify-content:center;align-items:center;height:100%"><img width="500" height="800" style="display:table-cell" src="/static/workloop-c34a0fb38f9964c94ebc3cd76c114f3a.gif" class="css-wnzno2"/></div></div><div style="flex:1;overflow:hidden;height:100%"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-n2kuek" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xdak34" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-keyword">let</span><span class="token-plain"> timerQueue </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-punctuation">[</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-comment">// 存放任务的队列</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-keyword">let</span><span class="token-plain"> taskQueue </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-punctuation">[</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-keyword">let</span><span class="token-plain"> shouldYield </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-boolean">false</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-comment">// 调度器</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">scheduleCallback</span><span class="token-punctuation">(</span><span class="token-parameter">task</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-plain">  </span><span class="token-comment">// 向队列中添加任务</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-plain">  taskQueue</span><span class="token-punctuation">.</span><span class="token-method">push</span><span class="token-punctuation">(</span><span class="token-plain">task</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-plain">  </span><span class="token-comment">// 优先级影响到任务在队列中的排序，将优先级最高的任务排在最前面</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-plain">  taskQueue</span><span class="token-punctuation">.</span><span class="token-method">sort</span><span class="token-punctuation">(</span><span class="token-punctuation">(</span><span class="token-parameter">a</span><span class="token-punctuation">,</span><span class="token-parameter"> b</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-arrow">=&gt;</span><span class="token-plain"> a</span><span class="token-punctuation">.</span><span class="token-property-access">priority</span><span class="token-plain"> </span><span class="token-operator">-</span><span class="token-plain"> b</span><span class="token-punctuation">.</span><span class="token-property-access">priority</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-10"><span class="token-plain">  </span><span class="token-comment">// 从队列中取出任务</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-11"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> currentTask </span><span class="token-operator">=</span><span class="token-plain"> taskQueue</span><span class="token-punctuation">[</span><span class="token-number">0</span><span class="token-punctuation">]</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-12"><span class="token-plain">  nextUnitOfWork </span><span class="token-operator">=</span><span class="token-plain"> currentTask</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-13"><span class="token-plain">  </span><span class="token-comment">// 请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-14"><span class="token-plain">  </span><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-15"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-16"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-17"><span class="token-comment">//根据优先级处理任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-18"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">workLoop</span><span class="token-punctuation">(</span><span class="token-parameter">deadline</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-19"><span class="token-plain">  </span><span class="token-console">console</span><span class="token-punctuation">.</span><span class="token-method">log</span><span class="token-punctuation">(</span><span class="token-string">&quot;workLoop&quot;</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-20"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> currentWork </span><span class="token-operator">=</span><span class="token-plain"> nextUnitOfWork</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-21"><span class="token-plain">  </span><span class="token-comment">//每次循环都会调用shouldYield判断当前是否有剩余时间。</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-22"><span class="token-plain">  </span><span class="token-keyword">while</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">currentWork </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">shouldYield</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-23"><span class="token-plain">    </span><span class="token-comment">// performUnitOfWork 是DFS（Depth-first search）遍历过程</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-24"><span class="token-plain">    nextUnitOfWork </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-plain">currentWork</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-25"><span class="token-plain">    shouldYield </span><span class="token-operator">=</span><span class="token-plain"> deadline</span><span class="token-punctuation">.</span><span class="token-method">timeRemaining</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-operator">&lt;</span><span class="token-plain"> </span><span class="token-number">1</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-26"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-27"><span class="token-plain">  </span><span class="token-comment">// 如果没有下个单元任务和工作树存在</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-28"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-operator">!</span><span class="token-plain">currentWork </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> wipRoot</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-29"><span class="token-plain">    </span><span class="token-comment">// 提交root任务</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-30"><span class="token-plain">    </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-31"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-32"><span class="token-plain">  </span><span class="token-comment">//请求主线程空闲时间进行工作循环;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-33"><span class="token-plain">  </span><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-34"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-35"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-36"><span class="token-comment">//构建 Fiber 树中每个 Fiber 的方法</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-37"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-38"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> isFunctionComponent </span><span class="token-operator">=</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-39"><span class="token-plain">    fiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-keyword">instanceof</span><span class="token-plain"> </span><span class="token-class-name">Function</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-40"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">isFunctionComponent</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-41"><span class="token-plain">    </span><span class="token-comment">//函数组件</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-42"><span class="token-plain">    </span><span class="token-function">updateFunctionComponent</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-43"><span class="token-plain">  </span><span class="token-punctuation">}</span><span class="token-plain"> </span><span class="token-keyword">else</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-44"><span class="token-plain">    </span><span class="token-comment">//类组件</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-45"><span class="token-plain">    </span><span class="token-function">updateHostComponent</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-46"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-47"><span class="token-plain">  </span><span class="token-comment">//调和子树</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-48"><span class="token-plain">  </span><span class="token-function">reconcileChildren</span><span class="token-punctuation">(</span><span class="token-plain">fiber</span><span class="token-punctuation">,</span><span class="token-plain"> children</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-49"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-50"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-51"><span class="token-comment">// 工作树</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-52"><span class="token-keyword">let</span><span class="token-plain"> currentRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-53"><span class="token-comment">// 虚拟树</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-54"><span class="token-keyword">let</span><span class="token-plain"> wipRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-55"><span class="token-comment">// 调和子树</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-56"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">reconcileChildren</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">,</span><span class="token-parameter"> children</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-57"><span class="token-plain">  </span><span class="token-keyword">const</span><span class="token-plain"> sameType </span><span class="token-operator">=</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-58"><span class="token-plain">    oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> element</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-plain"> </span><span class="token-operator">==</span><span class="token-plain"> oldFiber</span><span class="token-punctuation">.</span><span class="token-property-access">type</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-59"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-60"><span class="token-plain">    </span><span class="token-comment">// TODO update the node</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-61"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-62"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">element </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-63"><span class="token-plain">    </span><span class="token-comment">// TODO add this node</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-64"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-65"><span class="token-plain">  </span><span class="token-keyword">if</span><span class="token-plain"> </span><span class="token-punctuation">(</span><span class="token-plain">oldFiber </span><span class="token-operator">&amp;&amp;</span><span class="token-plain"> </span><span class="token-operator">!</span><span class="token-plain">sameType</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-66"><span class="token-plain">    </span><span class="token-comment">// TODO delete the oldFiber&#x27;s node</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-67"><span class="token-plain">  </span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-68"><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-69"><span class="token-plain">​</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-70"><span class="token-comment">// 更新视图</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-71"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-72"><span class="token-plain">  </span><span class="token-function">commitWork</span><span class="token-punctuation">(</span><span class="token-plain">wipRoot</span><span class="token-punctuation">.</span><span class="token-property-access">child</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-73"><span class="token-plain">  currentRoot </span><span class="token-operator">=</span><span class="token-plain"> wipRoot</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-74"><span class="token-plain">  wipRoot </span><span class="token-operator">=</span><span class="token-plain"> </span><span class="token-keyword">null</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:0.3;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-75"><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1xose5o" style="opacity:1"><span style="opacity:1">Work Loop</span></h4></div></div></div></div></div></div><div class="css-gxvojt"><div style="width:100vw;max-width:100%;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center" class="cs-layout"><div style="overflow:auto;height:100%;width:100%"><div style="overflow:auto;height:100%;width:100%"><div class="cs-container" style="width:100%;height:100%;max-height:100%;position:relative"><pre class="cs-content css-oedec6" style="margin:0;height:100%;overflow:hidden"><code class="cs-scaled-content css-xbe36b" style="display:block;height:100%;transform:scale(1);transform-origin:center 0px"><div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-0"><span class="token-comment">// 调度器</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-1"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">scheduleCallback</span><span class="token-punctuation">(</span><span class="token-parameter">task</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-2"><span class="token-comment">//请求空闲时间进行工作循环</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-3"><span class="token-function">requestIdleCallback</span><span class="token-punctuation">(</span><span class="token-plain">workLoop</span><span class="token-punctuation">)</span><span class="token-punctuation">;</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-4"><span class="token-comment">//根据优先级处理任务</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-5"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">workLoop</span><span class="token-punctuation">(</span><span class="token-parameter">deadline</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-6"><span class="token-comment">//构建 Fiber 树中每个 Fiber 的方法</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-7"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">performUnitOfWork</span><span class="token-punctuation">(</span><span class="token-parameter">fiber</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-8"><span class="token-comment">//更新视图</span></div></div><div style="overflow:hidden;height:100px;opacity:1;transform:translateX(0px)"><div style="display:inline-block" class="cs-line cs-line-9"><span class="token-keyword">function</span><span class="token-plain"> </span><span class="token-function">commitRoot</span><span class="token-punctuation">(</span><span class="token-punctuation">)</span><span class="token-plain"> </span><span class="token-punctuation">{</span><span class="token-punctuation">}</span></div></div><div></div></code></pre><h4 class="cs-title css-1q54swq" style="opacity:1"><span style="opacity:1">Fiber 更新流程</span></h4><p class="cs-subtitle css-fs2d1k" style="opacity:1"><span style="opacity:1">请问大家有什么问题吗？（虽然我可能回答不了）</span></p></div></div></div></div></div><div class="css-gxvojt"><p class="css-0">docs：<style data-emotion-css="199bzt4">.css-199bzt4{color:var(--theme-ui-colors-primary,rgb(206,145,120));}</style><a href="https://codesurfer.pomb.us" class="css-199bzt4">codesurfer.pomb.us</a></p><p class="css-0">部署网页 page：<a href="http://huawink.fun/" class="css-199bzt4">huawink.fun</a></p><p class="css-0">参考文档：<a href="https://pomb.us/build-your-own-react/" class="css-199bzt4">build-your-own-react</a></p><p class="css-0">源代码：<a href="https://github.com/huahuahuahuahuahua/react-fiber-slide-mdxDeck.git" class="css-199bzt4">react-fiber-slide-mdxDeck</a></p><p class="css-0">ppt 所用工具：<a href="https://github.com/huahuahuahuahuahua/mdx-deck-slide-decks" class="css-199bzt4">mdx-deck-slide-decks</a></p></div><div class="css-gxvojt"><h2 class="css-1djqpdg">谢谢大家</h2></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/print";window.webpackCompilationHash="76685a68c1bb3378e90c";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-901f5929c480a9ffd786.js"],"component---gatsby-theme-mdx-deck-src-templates-deck-js":["/component---gatsby-theme-mdx-deck-src-templates-deck-js-862c04b17d6a8697b9b0.js"]};/*]]>*/</script><script src="/component---gatsby-theme-mdx-deck-src-templates-deck-js-862c04b17d6a8697b9b0.js" async=""></script><script src="/app-901f5929c480a9ffd786.js" async=""></script><script src="/commons-15505dbdcd717bdf87dd.js" async=""></script><script src="/webpack-runtime-6325f01cfc8204c7dff0.js" async=""></script></body></html>